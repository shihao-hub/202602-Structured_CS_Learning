# 总线 (Bus)

## 408 考试映射

本模块涵盖计算机组成原理 408 考试中的总线相关内容。这是一个纯概念性模块，无需代码实现。

## 1. 总线的基本概念

### 什么是总线？
总线（Bus）是计算机各部件之间传送信息的**公共通路**。它是一组信号线的集合，多个部件可以共享这些线路。

### 总线的特点
- **分时工作**：同一时刻只能有一对设备使用总线通信
- **共享性**：多个设备共用同一组信号线
- **需要仲裁**：多个设备竞争使用时，需要仲裁机制

## 2. 总线的分类

### 2.1 按连接部件分类

#### 片内总线
- 连接 CPU 内部各部件的总线
- 例：ALU 与寄存器之间的总线

#### 系统总线（最重要！）
连接 CPU、主存、I/O 接口的总线，分为三类：

##### (1) 数据总线（Data Bus）
- **功能**：传送数据信息（指令、数据、地址）
- **特点**：双向传输
- **宽度**：决定了一次能传送的数据位数
  - 8 位、16 位、32 位、64 位...
  - 宽度越大，性能越好
- **例**：32 位数据总线，一次可传送 4 字节

##### (2) 地址总线（Address Bus）
- **功能**：传送地址信息（主存地址、I/O 端口地址）
- **特点**：单向传输（从 CPU 发出）
- **宽度**：决定了最大寻址空间
  - n 位地址总线 → 最大寻址空间 = 2^n
  - 例：32 位地址总线 → 4GB 地址空间
- **注意**：地址总线的位数决定了内存容量的上限

##### (3) 控制总线（Control Bus）
- **功能**：传送控制信号（读/写、中断请求、总线请求等）
- **特点**：有入有出（双向，但每根线单向）
- **常见控制信号**：
  - 读信号（Read）
  - 写信号（Write）
  - 中断请求（INTR）
  - 中断响应（INTA）
  - 总线请求（BR）
  - 总线允许（BG）
  - 时钟信号（CLK）
  - 复位信号（RESET）

#### 通信总线（外部总线）
- 连接计算机与外部设备的总线
- 例：USB、网络总线

### 2.2 按数据传送方式分类

#### 串行总线
- 数据按**位**串行传输
- 优点：成本低，适合长距离传输
- 缺点：速度慢
- 例：USB、SATA

#### 并行总线
- 数据按**字节或字**并行传输
- 优点：速度快
- 缺点：成本高，有信号干扰
- 例：ISA、PCI

### 2.3 按时序控制方式分类

#### 同步总线
- 由统一的**时钟信号**协调发送和接收
- 优点：逻辑简单，速度快
- 缺点：不适合速度差异大的设备

#### 异步总线
- 采用**应答方式**（握手协议）
- 优点：灵活，适合速度差异大的设备
- 缺点：速度相对较慢，硬件复杂

## 3. 总线仲裁（重点！）

当多个主设备同时请求使用总线时，需要**总线仲裁机制**来决定优先权。

### 3.1 集中式仲裁（Centralized Arbitration）

由一个**集中的总线仲裁器**统一管理。

#### (1) 链式查询（Daisy Chain）

```
        BR (总线请求，或逻辑)
CPU ←━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
        BG (总线允许)              ║
    ━━→ □ ━━→ □ ━━→ □            ║
       设备1  设备2  设备3         ║
        ┗━━━━━┻━━━━━┻━━━━━━━━━━━━┛
```

- **工作原理**：
  1. 设备需要总线时，发出总线请求信号 BR
  2. 仲裁器收到 BR 后，发出总线允许信号 BG
  3. BG 信号串行通过各设备，**离仲裁器近的设备优先级高**
  4. 得到 BG 的设备使用总线，不传递 BG 给下一设备
  
- **优点**：
  - 硬件简单，容易扩充
  - 只需 2 根控制线（BR、BG）
  
- **缺点**：
  - 优先级固定（不够灵活）
  - 对电路故障敏感（一个设备故障，影响后面所有设备）

#### (2) 计数器定时查询

```
           BR
CPU ←━━━━━━━━━━━━━━━━━━━┓
           BS (总线忙)     ║
CPU ━━━━━━━━━━━━━━━━━━━→ ║
           设备地址         ║
CPU ━━━━━━━━━━━━━━━━━━━→ ║
           ┃                ║
    ┏━━━━━┻━━━━━┓          ║
   设备1  设备2  设备3       ║
    ┗━━━━━┻━━━━━┻━━━━━━━━━┛
```

- **工作原理**：
  1. 仲裁器内有计数器，指示设备编号
  2. 设备发出 BR 请求
  3. 仲裁器通过设备地址线发出计数值
  4. 计数值与设备编号一致的设备获得使用权
  5. 计数器可以循环递增（轮询）或从 0 开始（固定优先级）
  
- **优点**：
  - 优先级可变（计数器起始值可改）
  - 对故障不敏感
  
- **缺点**：
  - 需要额外的设备地址线（log₂n 根线，n 为设备数）
  - 查询时间较长

#### (3) 独立请求方式

```
     BR1  BR2  BR3  BR4
CPU ←━━━←━━━←━━━←━━━━ (每个设备一根 BR)
     BG1  BG2  BG3  BG4
CPU ━━━→━━━→━━━→━━━→ (每个设备一根 BG)
     ┃    ┃    ┃    ┃
    设备1 设备2 设备3 设备4
```

- **工作原理**：
  1. 每个设备都有独立的请求线 BRi 和允许线 BGi
  2. 仲裁器内部有优先级排队电路
  3. 多个请求同时到达时，按优先级响应
  
- **优点**：
  - 响应速度快
  - 优先级灵活可控
  - 对故障不敏感
  
- **缺点**：
  - 控制线多（2n 根，n 为设备数）
  - 硬件复杂，成本高

### 3.2 分布式仲裁（Distributed Arbitration）

- 不需要集中的仲裁器
- 每个设备自己通过算法判断优先级
- 例：**自举分布式仲裁**、**冲突检测仲裁**（类似以太网 CSMA/CD）

### 集中式 vs 分布式

| 特性 | 集中式 | 分布式 |
|------|-------|--------|
| 仲裁器 | 有集中的仲裁器 | 无中央仲裁器 |
| 可靠性 | 仲裁器故障影响全部 | 可靠性高 |
| 复杂度 | 相对简单 | 复杂 |
| 响应速度 | 一般 | 较快 |

## 4. 总线定时（时序）

总线定时指的是总线在一个传输周期内的时序关系。

### 同步定时
- 由统一时钟控制
- 所有事件按时钟周期发生
- 简单但不灵活

### 异步定时（握手协议）

#### 不互锁方式（无应答）
- 主设备发出请求后，不等应答
- 快但不可靠

#### 半互锁方式
- 主设备等待从设备应答
- 从设备不等主设备撤销请求

#### 全互锁方式（最可靠）
```
主设备 ━━┓   请求   ┏━━━━━━━━━━━━━━━━
         ┗━━━━━━━━━┛
从设备        ┏━━━━━━┓  应答
         ━━━━┛      ┗━━━━━━━━━━━━
```
1. 主设备发请求
2. 从设备收到请求，发应答
3. 主设备收到应答，撤销请求
4. 从设备检测到请求撤销，撤销应答

## 5. 常见总线标准

### 5.1 ISA (Industry Standard Architecture)
- 16 位数据总线
- 已过时

### 5.2 PCI (Peripheral Component Interconnect)
- 32/64 位并行总线
- 33/66 MHz 时钟频率
- 支持总线仲裁和突发传输

### 5.3 PCI Express (PCIe)
- 串行总线，点对点连接
- 采用**通道**（Lane）概念
  - x1, x4, x8, x16（通道数）
- 高速，可扩展
- 当前主流

### 5.4 USB (Universal Serial Bus)
- 串行总线
- 热插拔、即插即用
- USB 2.0: 480 Mbps
- USB 3.0: 5 Gbps
- USB 3.1: 10 Gbps
- **主从结构**，主机控制

### 5.5 AGP (Accelerated Graphics Port)
- 专为显卡设计
- 已被 PCIe 取代

### 总线标准对比

| 总线 | 类型 | 位宽 | 频率 | 带宽 |
|------|------|------|------|------|
| ISA | 并行 | 16位 | 8MHz | 16MB/s |
| PCI | 并行 | 32位 | 33MHz | 133MB/s |
| PCI-X | 并行 | 64位 | 133MHz | 1GB/s |
| PCIe 3.0 x16 | 串行 | - | - | 16GB/s |
| USB 2.0 | 串行 | - | - | 60MB/s |
| USB 3.0 | 串行 | - | - | 625MB/s |

## 6. 总线性能指标

### 6.1 总线宽度
- 数据总线的位数
- 决定一次传输的数据量

### 6.2 总线频率
- 总线的工作频率（时钟频率）
- 单位：MHz、GHz

### 6.3 总线带宽（重要！）

**总线带宽 = 总线宽度 × 总线频率**

**公式**：
```
带宽（字节/秒）= (总线宽度 / 8) × 总线频率
```

**例题**：
- 32 位数据总线，工作频率 66MHz
- 带宽 = (32 / 8) × 66M = 4 × 66M = 264 MB/s

### 6.4 总线复用
- 地址总线和数据总线**分时共用**同一组线路
- 优点：减少总线数量，降低成本
- 缺点：降低传输效率

## 7. 408 考试要点总结

### 7.1 概念理解

1. **总线的三种类型**：数据总线、地址总线、控制总线
   - 数据总线：双向，宽度决定传输效率
   - 地址总线：单向，位数决定寻址空间（2^n）
   - 控制总线：双向，传输控制信号

2. **总线仲裁的三种方式**：
   - 链式查询：简单，优先级固定
   - 计数器定时查询：优先级可变
   - 独立请求：速度快，硬件复杂

3. **同步总线 vs 异步总线**

### 7.2 计算题

#### 地址总线位数与寻址空间
```
n 位地址总线 → 最大寻址空间 = 2^n 字节
```

**例**：
- 32 位地址总线 → 2^32 = 4GB
- 20 位地址总线 → 2^20 = 1MB

#### 总线带宽计算
```
带宽 = (数据总线宽度 / 8) × 总线频率 × 传输效率
```

**例题**：
> 某总线有 32 根数据线，时钟频率为 100MHz，每个时钟周期传输一次数据，求总线带宽。

**解**：
```
带宽 = (32 / 8) × 100M = 4 × 100M = 400 MB/s
```

#### 突发传输带宽
- 第一次传输需要 n 个周期（地址、握手等开销）
- 后续每次 1 个周期
- 突发传输 m 个数据：总周期 = n + (m-1)

### 7.3 典型考题

1. **判断题/选择题**
   - 总线的特点（分时、共享）
   - 三种总线的功能和特点
   - 仲裁方式的优缺点
   - 总线标准（PCI、PCIe、USB）

2. **计算题**
   - 根据地址总线位数计算寻址空间
   - 根据数据总线宽度和频率计算带宽
   - 突发传输的时间和带宽计算

3. **简答题**
   - 比较不同仲裁方式的优缺点
   - 说明同步总线和异步总线的区别
   - 解释总线复用的概念

### 7.4 必记知识点

```
┌────────────────────────────────────────────┐
│ 地址总线位数 → 最大寻址空间 = 2^n         │
│ 数据总线宽度 → 一次传输的数据量           │
│ 总线带宽 = (位宽/8) × 频率                │
│                                            │
│ 链式查询:     优先级固定，硬件简单        │
│ 计数器查询:   优先级可变，需地址线        │
│ 独立请求:     速度快，控制线多            │
│                                            │
│ 同步总线:     时钟控制，速度快            │
│ 异步总线:     握手协议，灵活可靠          │
└────────────────────────────────────────────┘
```

## 8. 记忆技巧

### 总线分类记忆口诀
```
按连接分：片内、系统、通信
系统总线三兄弟：数据双、地址单、控制双
按传送分：串行慢、并行快
按时序分：同步快、异步稳
```

### 仲裁方式记忆
```
链式查询：像排队，前面的先
计数器：像点名，轮流来
独立请求：像 VIP，专线快
```

### 带宽计算口诀
```
位宽除八变字节，
再乘频率得带宽。
```

## 总结

总线是计算机系统的"交通要道"，408 考试中主要考查：
1. 三种系统总线的功能和特点
2. 地址总线位数与寻址空间的计算
3. 总线带宽的计算
4. 三种集中式仲裁方式的对比
5. 同步与异步总线的区别
6. 常见总线标准（PCI、PCIe、USB）

**重点**：理解总线仲裁机制，掌握带宽和寻址空间的计算方法。
